# MCPサーバ実装計画（更新版）

## 1. 設計概要

### 1.1 機能要件
- ローカルディレクトリのGoモジュールのgodocをMCP経由でアクセス可能にする
- 起動時のオプション
  - ディレクトリルートパス（必須）
  - 特定のパッケージディレクトリ（オプション）
- 起動時にGoファイルを再帰的に読み込み、ドキュメント情報を保持

### 1.2 使用ライブラリ
- go-mcp
  - MCPサーバーの実装に使用
  - 型安全性を確保
  - コード生成による効率的な開発
  - パッケージ名: `github.com/ktr0731/go-mcp`
  - 主要なサブパッケージ:
    - `github.com/ktr0731/go-mcp/codegen`: コード生成用
    - `github.com/ktr0731/go-mcp/mcp`: MCPサーバー実装用
- golang.org/x/tools/go/packages
  - Goパッケージの解析に使用
  - 高レベルAPIによる効率的な実装
  - 依存関係の自動解決
  - 型情報の完全な解析
  - Go Modulesとの互換性
- golang.org/x/tools/godoc
  - Goドキュメントの解析と表示に使用
  - コメントからドキュメント情報を抽出

### 1.3 MCPツール
1. `list_packages`
   - 読み込んだパッケージの一覧表示
   - パッケージコメントの出力

2. `inspect_package`
   - パッケージ内の公開構造体、メソッド、関数のリスト表示
   - 引数: パッケージ名、コメント有無（オプション）

3. `get_doc_struct`
   - 構造体情報の取得
   - 引数: パッケージ名、構造体名

4. `get_doc_func`
   - 関数情報の取得
   - 引数: パッケージ名、関数名

5. `get_doc_method`
   - 構造体メソッド情報の取得
   - 引数: パッケージ名、構造体名、メソッド名

6. `get_doc_const_and_var`
   - 定数・変数情報の取得
   - 引数: パッケージ名

## 2. 実装ステップ

### 2.1 プロジェクト構造の整理
- [x] プロジェクト構造の作成
  - [x] `cmd/mcpgen/`ディレクトリの作成
  - [x] `cmd/server/`ディレクトリの作成
  - [x] `internal/handler/`ディレクトリの作成
  - [x] `internal/model/`ディレクトリの作成
  - [x] `internal/parser/`ディレクトリの作成（Goファイル解析用）

### 2.2 コード生成の設定
- [x] `cmd/mcpgen/main.go`の実装
  - [x] サーバー定義の作成
  - [x] コード生成の実行
    - `go run ./cmd/mcpgen`

### 2.3 サーバー実装
- [x] `cmd/server/main.go`の実装
  - [x] コマンドラインオプションの実装
  - [x] パーサーの初期化
  - [x] MCPサーバーの起動
  - [x] エラーハンドリング

### 2.4 ツールハンドラーの実装
- [ ] `internal/handler/handler.go`の実装
  - [x] ハンドラー構造体の定義
  - [ ] `list_packages`ハンドラーの実装
    - [x] 基本的な実装
    - [ ] 適切なフォーマットの実装
  - [ ] `inspect_package`ハンドラーの実装
    - [x] 基本的な実装
    - [ ] パッケージの構造体、メソッド、関数の情報抽出
  - [ ] `get_doc_struct`ハンドラーの実装
    - [x] 基本的な実装
    - [ ] 構造体情報の抽出
  - [ ] `get_doc_func`ハンドラーの実装
    - [x] 基本的な実装
    - [ ] 関数情報の抽出
  - [ ] `get_doc_method`ハンドラーの実装
    - [x] 基本的な実装
    - [ ] メソッド情報の抽出
  - [ ] `get_doc_const_and_var`ハンドラーの実装
    - [x] 基本的な実装
    - [ ] 定数・変数情報の抽出
  - [x] エラーハンドリング
  - [ ] レスポンスの整形
    - [ ] マークダウン形式での出力
    - [ ] コードブロックの適切な使用

### 2.5 Goファイル解析の実装
- [x] `internal/parser/parser.go`の実装
  - [x] `golang.org/x/tools/go/packages`を使用したパッケージロード
    - [x] `New`関数によるパッケージのロード
    - [x] `GetAllPackages`関数による全パッケージの取得
    - [x] `GetPackage`関数による特定パッケージの取得
  - [x] パッケージ情報の抽出
  - [x] 構造体情報の抽出
    - [x] `GetStructInfo`関数による構造体情報の取得
    - [x] フィールド情報の取得
    - [x] メソッド情報の取得
  - [x] 関数情報の抽出
    - [x] `GetFuncInfo`関数による関数情報の取得
    - [x] 例の取得
  - [x] メソッド情報の抽出
    - [x] `GetMethodInfo`関数によるメソッド情報の取得
    - [x] 例の取得
  - [x] 定数・変数情報の抽出
    - [x] `GetConstAndVarInfo`関数による定数・変数情報の取得
  - [ ] パフォーマンス最適化
    - [ ] 並行処理による解析の高速化
    - [ ] メモリ使用量の最適化
    - [ ] インクリメンタル解析の実装（オプション）

### 2.6 データモデルの設計
- [x] `internal/model/model.go`の実装
  - [x] MCPツールのリクエストパラメータを表す構造体や、レスポンス整形用の補助的な構造体を定義する

### 2.7 レスポンス設計
- [x] 各ツールのレスポンス形式の定義
  - [x] 共通レスポンス構造の設計
  - [x] `list_packages`のレスポンス
  - [x] `inspect_package`のレスポンス
  - [x] `get_doc_struct`のレスポンス
  - [x] `get_doc_func`のレスポンス
  - [x] `get_doc_method`のレスポンス
  - [x] `get_doc_const_and_var`のレスポンス

### 2.8 テストの実装
- [ ] ユニットテストの作成
  - [ ] ハンドラーのテスト
  - [ ] パーサーのテスト
    - [ ] パッケージロードのテスト
    - [ ] 情報抽出のテスト
    - [ ] エラーケースのテスト
  - [ ] モデルのテスト
    - [ ] データモデルの操作テスト
    - [ ] 検索機能のテスト
- [ ] 統合テストの作成
  - [ ] サーバー全体のテスト
    - [ ] コマンドラインオプションのテスト
    - [ ] エンドツーエンドのテスト
  - [ ] テストデータの準備
    - [ ] サンプルGoコードの作成
    - [ ] 期待される出力の定義

## 3. 実装の優先順位

1. 基本的なMCPサーバーの構築
   - [x] コード生成の設定
   - [x] サーバーの起動
   - [x] 基本的なツールの実装

2. Goファイル解析の実装
   - [x] `golang.org/x/tools/go/packages`を使用したパーサーの実装
   - [x] 情報抽出の実装
   - [x] データモデルの実装

3. ツールハンドラーの実装
   - [ ] 各ツールのハンドラー実装
   - [x] レスポンス形式の統一
   - [x] エラーハンドリングの実装

4. テストとドキュメントの整備
   - [ ] ユニットテスト
   - [ ] 統合テスト
   - [ ] APIドキュメント
   - [ ] 使用例の作成

## 4. 注意点

- [ ] 型安全性の確保
  - [ ] コード生成による型安全なインターフェースの実現
  - [ ] 適切な型変換の実装

- [ ] エラーハンドリングの徹底
  - [ ] 具体的なエラーケースの特定と対応
  - [ ] ユーザーフレンドリーなエラーメッセージ
  - [ ] エラーの適切な伝播

- [ ] パフォーマンスの考慮
  - [ ] 大規模プロジェクトでの動作確認
  - [ ] メモリ使用量の最適化
  - [ ] 並行処理の活用

- [ ] Goファイル解析の正確性
  - [ ] コメント解析の正確性
  - [ ] 型情報の正確な抽出
  - [ ] エッジケースの考慮

## 5. 次のステップ

1. [x] プロジェクト構造の作成
2. [x] `cmd/mcpgen/main.go`の実装
3. [x] 基本的なツールの定義
4. [x] コード生成の実行
5. [x] `internal/model/model.go` の実装 (MCPパラメータ/レスポンス整形用構造体)
6. [x] `internal/parser/parser.go`の実装
7. [x] `internal/handler/handler.go`の実装 (基本実装)
8. [x] `cmd/server/main.go`の実装
9. [ ] テストの実装
10. [ ] ドキュメントの整備

## テストコードの指摘事項

1. テストケースの定義形式
   - `[]struct`ではなく`map[string]struct`を使用する
   - テストケースの名前を`name`フィールドからマップのキーに移動する

2. 並列実行
   - 各テスト関数の先頭に`t.Parallel()`を追加する
   - サブテスト内でも`t.Parallel()`を呼び出す

3. ループ変数のシャドウイング
   - Go 1.24以降では`tt := tt`は不要
   - 以前のバージョンでは必要だったが、現在は不要

4. JSONの比較
   - 文字列として直接比較するのではなく、一度パースしてから比較する
   - これにより、JSONの整形の違いを無視できる

## 次のタスク

1. パーサーの実装
   - [x] `golang.org/x/tools/go/packages`を使用したパッケージロード
   - [x] パッケージ情報の抽出
   - [x] 構造体情報の抽出
   - [x] 関数情報の抽出
   - [x] メソッド情報の抽出
   - [x] 定数・変数情報の抽出

2. ハンドラーの実装
   - [ ] `list_packages`ハンドラーの実装
     - [x] 基本的な実装
     - [ ] 適切なフォーマットの実装
   - [ ] `inspect_package`ハンドラーの実装
     - [x] 基本的な実装
     - [ ] パッケージの構造体、メソッド、関数の情報抽出
   - [ ] `get_doc_struct`ハンドラーの実装
     - [x] 基本的な実装
     - [ ] 構造体情報の抽出
   - [ ] `get_doc_func`ハンドラーの実装
     - [x] 基本的な実装
     - [ ] 関数情報の抽出
   - [ ] `get_doc_method`ハンドラーの実装
     - [x] 基本的な実装
     - [ ] メソッド情報の抽出
   - [ ] `get_doc_const_and_var`ハンドラーの実装
     - [x] 基本的な実装
     - [ ] 定数・変数情報の抽出
   - [ ] レスポンスの整形
     - [ ] マークダウン形式での出力
     - [ ] コードブロックの適切な使用

3. パフォーマンス最適化
   - [ ] 並行処理による解析の高速化
   - [ ] メモリ使用量の最適化
   - [ ] インクリメンタル解析の実装（オプション）

4. テストの実装
   - [ ] ハンドラーのテスト
     - [ ] 各ツールハンドラーの入出力テスト
     - [ ] エラーケースのテスト
   - [ ] パーサーのテスト
     - [ ] パッケージロードのテスト
     - [ ] 情報抽出のテスト
     - [ ] エラーケースのテスト
   - [ ] 統合テスト
     - [ ] サーバー全体のテスト
     - [ ] テストデータの準備

5. ドキュメントの整備
   - [ ] READMEの更新
   - [ ] 使用例の追加

## 今後の改善点

1. テストカバレッジの確認
2. エラーケースのテスト追加
3. テストヘルパー関数の作成
4. テストデータの共通化